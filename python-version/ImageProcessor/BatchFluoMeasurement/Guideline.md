开发 Guideline：单细胞时间序列荧光强度批量测量工具  

------------------------------------------------
1. 项目目标  
   输入：  
   - 1 张明场 TIFF（用于定位细胞；UI文件选择器）  
   - N 张按时间顺序拍摄的荧光 TIFF（同一视野，细胞未移动；UI文件夹选择器选择路径）  
   - N 张黑场 TIFF（系统暗电流校准；UI文件选择器，允许选择多个）  

   输出：  
   - CSV：每行 = 时间点（图片修改时间，精确到秒） + 相对时间（以第一章荧光Tiff的修改时间为0开始计算，单位是秒） + 细胞轮廓内荧光强度（Mean/Total/Area）
   - PNG：明场轮廓叠加图（用于QC；用绿色显示细胞轮廓，在左上角显示细胞面积）  
   - UI选择保存路径

   核心要求：**零手动干预**、**保留 16-bit 线性**、**用拍摄时间戳作为时间轴**。

------------------------------------------------
2. 文件与命名规范（可配置）  
   - 主目录下子文件夹结构或扁平文件均可，由用户通过 GUI/CLI 选择；  
   - 明场固定关键词：`*brightfield*` 或 `*_BF.tif`；  
   - 荧光序列：任意名，但按照文件名从小到大排序，且需含 EXIF DateTime 标签；  
   - 黑场固定关键词：`*dark*` 或 `*_dark.tif`；  
   - 输出文件统一写到 `<user_sel>/results/` 目录。
   - 使用windows路径风格
   - 提供中文路径和中文文件名支持

------------------------------------------------
3. 数据读取与位深保护  
   - 必须原生支持 16-bit BigTIFF（>4 GB 可 mem-map）；  
   - 禁止提前转 8-bit；  
   - 若图像宽高为奇数，抛异常并提示“Bayer 尺寸非法”；  
   - 黑场读取后同样做 Bayer 拆分（仅需要 R 子图）。

------------------------------------------------
4. Bayer 拆分（RGGB 固定顺序）  
   - 对明场图和荧光图都执行：R = 偶行偶列 raw[0::2, 0::2]； 明场图用于定位细胞，荧光图用于计算荧光强度；  
   - 拆分后数据类型 float32；  

------------------------------------------------
5. 明场 → 单细胞掩膜（一次性）  
   1. 高斯模糊 σ=1–2 pixel，去噪；  
   2. 自动阈值（Otsu/Triangle）或深度学习分割，得到二值 mask；  
   3. 形态学关闭（disk r=3）+ 打开（disk r=2），去小渣；  
   4. 保留最大连通域（或前几大，可配置）；  
   5. 保存 mask 为 PNG（可视化）与 npy/pkl（布尔数组）供后续复用；  
   6. 若用户希望手动修正，提供“点击-多边形”界面，但**仅影响 mask 生成步骤**，不改原图像素。

------------------------------------------------
6. 黑电平校准（一次性常数）  
   - 对所有黑场拆 R 后，取平均值作为 dark_value.tif；   
   - 所有荧光帧共用同一 dark_value.tif 做减法：  
     ```
     corr_R = raw_R – dark_value.tif  
     corr_R = max(corr_R, 0)
     ```

------------------------------------------------
7. 时间序列批量循环
   1. 扫描荧光文件夹下所有文件，按 **EXIF DateTimeOriginal** 排序；  
   2. 第一张设为 t=0，后续帧计算相对秒数 elapsed_s；  
   3. 对每帧：
      - 拆 R → 减 dark → 得 float32 线性图；  
      - 用预存 mask 取像素：  
        area = mask.sum()  
        total = sum(corr_R[mask])  
        mean = total / area  
      - 记录：DateTime, elapsed_s, frame_i, Mean, Total, Area  
   4. 进度条 + 日志（帧数、异常、空文件警告）。

------------------------------------------------
8. 输出文件与格式
   - CSV 列：  
     `DateTimeOriginal,elapsed_s,frame_i,Mean,Total,Area`  
     浮点保留 3 位小数，时间 ISO-8601。   
   - 叠加图 PNG：明场灰度 + 绿色轮廓线，DPI≥300，供论文插图。  
   - 日志 txt：软件版本、参数、帧数、异常信息。

------------------------------------------------
9. 用户界面（二选一）
   - CLI：  
     ```
     python [EntranceFile].py -i <folder> -dark <dark.tif> -o <out>
     ```  
   - GUI：文件夹拖拽、进度条、参数滑块（高斯 σ、最小面积、阈值算法）、预览 mask、一键导出。

------------------------------------------------
10. 性能与鲁棒
    - 支持内存映射（tifffile.memmap）防 4 GB 以上大图爆 RAM；  
    - 中断续跑：已写 CSV 行跳过，不重复计算；  
    - 异常帧写入日志继续，不整体崩溃；  
    - 多线程可选（tifffile + joblib），但须保证写入顺序。

------------------------------------------------
11. 测试与验收
    - 验收标准：  
      - CSV 行数 = 荧光图张数；  
      - 第一张 elapsed_s = 0；  
      - 叠加图轮廓与明场边缘重合度目视通过。

------------------------------------------------
12. 文档交付
    - README：安装、运行、参数说明、故障排查；  
    - 参数表 yaml 示例；  
    - 结果 CSV 列含义；  
    - 引用格式（若使用第三方阈值/分割库）。

------------------------------------------------
