# 标尺测量工具 - 使用说明

## 功能特性

✅ **完整支持中文路径** - 可以从包含中文的文件夹加载图像  
✅ **支持16位TIFF** - 支持8位和16位灰度TIFF图像  
✅ **高斯模糊处理** - 可调节模糊强度（σ = 0-5.0），有助于降噪  
✅ **自适应线条粗细** - 线条粗细根据图像尺寸自动调整  
✅ **交互式缩放** - 鼠标滚轮缩放，右键拖拽平移  
✅ **精确测量** - 绘制线段计算像素-微米比例  
✅ **结果导出** - 保存为JSON格式供后续分析使用  

## 快速开始

### 1. 启动程序

```bash
python scale_bar_measurement.py
```

或双击 `run.bat`

### 2. 加载图像

1. 点击"Load Image"按钮
2. 选择包含标尺的灰度TIFF图像
3. **支持中文路径**，如：`E:/文档/显微镜图像/标尺图.tif`

### 3. 调整图像处理参数（可选）

**高斯模糊（Gaussian Blur）:**
- 拖动"Image Processing"面板中的滑块调整模糊强度（σ值）
- σ = 0：无模糊（默认）
- σ = 0.5-1.5：轻度平滑，适合轻微噪声
- σ = 2.0-3.0：中度平滑，适合中等噪声
- σ = 3.0-5.0：强烈平滑，适合高噪声图像
- **建议**: 如果标尺边缘清晰，保持σ=0；如果噪声较大，尝试σ=1.0-2.0

### 4. 测量标尺

1. 在"Real Distance (μm)"输入框输入标尺的实际长度（默认100微米）
2. 使用鼠标滚轮缩放到标尺位置
3. 在图像上**点击并拖动**画一条线，沿着标尺
4. 松开鼠标后自动计算像素-微米比例

### 5. 查看结果

结果面板显示：
- **Pixel Distance**: 线段的像素长度
- **Real Distance**: 实际物理距离（微米）
- **Ratio**: 像素/微米比例
- **Inverse**: 微米/像素比例

### 6. 保存结果

点击"Save Result"保存为JSON文件，供其他程序使用。

## 操作技巧

### 鼠标操作
- **左键拖动**: 绘制测量线
- **右键拖动**: 平移图像
- **鼠标滚轮**: 缩放（以鼠标位置为中心）

### 键盘快捷键
- `+` 或 `=`: 放大
- `-`: 缩小
- `F`: 适应窗口大小

### 重新测量
点击"Clear Line"清除当前线段，重新绘制。

## 中文路径支持说明

本工具使用 `numpy.fromfile()` + `cv2.imdecode()` 方法加载图像，完全支持包含中文字符的文件路径，例如：

- ✅ `E:/实验数据/2025年10月/细胞图像.tif`
- ✅ `C:/用户/张三/OneDrive/课题组/标尺测量.tif`
- ✅ `D:/显微镜/标定图像/100微米标尺.tiff`

## 输出JSON格式

```json
{
  "timestamp": "2025-10-11T16:00:00",
  "image_path": "E:/文档/图像.tif",
  "pixel_distance": 300.0,
  "real_world_distance_um": 100.0,
  "pixels_per_micron": 3.0,
  "microns_per_pixel": 0.3333
}
```

## 在其他程序中使用校准数据

```python
import json

# 加载校准数据
with open('calibration.json', 'r', encoding='utf-8') as f:
    calib = json.load(f)

pixels_per_micron = calib['pixels_per_micron']

# 转换测量值
area_pixels = 1000
area_microns_squared = area_pixels / (pixels_per_micron ** 2)

print(f"细胞面积: {area_microns_squared:.2f} μm²")
```

## 常见问题

### Q: 图像加载失败？
A: 确保文件是TIFF格式（.tif 或 .tiff），支持8位和16位灰度图像。

### Q: 测量不准确？
A: 
1. 放大图像以更精确地沿标尺绘制线段
2. 确保输入的实际距离正确
3. 绘制线段时尽量沿标尺中心线

### Q: 中文路径仍然报错？
A: 
1. 确保使用最新版本的代码
2. 检查文件路径中是否有特殊字符
3. 尝试将图像复制到纯英文路径测试

## 技术支持

如遇问题，请检查：
1. Python版本 >= 3.7
2. 已安装所需依赖：`pip install -r requirements.txt`
3. OpenCV版本 >= 4.5.0
