# 多图拼接工具 (Multi-Image Layout Tool)

一个功能强大的图片拼接工具，支持任意张同比例图片的自动布局与导出。

## ✨ 主要功能

### 1. 图片加载
- **文件夹加载**: 一次性加载整个文件夹中的所有图片
- **文件选择**: 多选特定图片文件
- **自动缓存**: 图片元数据自动缓存，二次加载更快
- **宽高比检测**: 自动检测图片宽高比，不匹配时可选择自动裁切

### 2. 灵活布局
- **预设方案**: 5×5、6×6、3×8、4×10等多种预设
- **自定义布局**: 自由设置行列数(1-50)
- **智能建议**: 根据图片数量自动推荐最佳布局
- **末行处理**: 支持居左、居中、分散三种空格策略
- **质数优化**: 自动识别质数图片数，推荐最佳布局

### 3. 单元格控制
- **尺寸调节**: 10-2000px范围，步长10px
- **宽高比锁定**: 保持原始图片比例
- **一键还原**: 快速恢复原始尺寸

### 4. 编号系统
- **多种格式**: 
  - 1 2 3 (阿拉伯数字)
  - ① ② ③ (带圈数字)
  - a b c (小写字母)
  - A B C (大写字母)
  - i ii iii (小写罗马数字)
  - I II III (大写罗马数字)
- **九宫格定位**: 支持9个位置(左上、中上、右上...)
- **字体控制**: 字号8-200px，自定义颜色
- **背景开关**: 可选半透明背景提高可读性

### 5. Scale Bar (比例尺)
- **物镜选择**: 4X、10X、20X (已配置10X: 1.0304 μm/px)
- **长度可调**: 1-1000 μm，默认10 μm
- **位置选择**: 左下、居中、右下
- **自动计算**: 根据物镜倍率自动计算像素长度
- **白底黑字**: 默认白色比例尺，黑色背景，增强可见性

### 6. 实时预览
- **无级缩放**: 鼠标滚轮缩放，范围5%-800%
- **缩放控制**: 放大、缩小、适应窗口、实际大小
- **网格显示**: 可切换网格线辅助对齐
- **空格提示**: 斜线阴影标识空白单元格
- **拖拽排序**: 鼠标拖拽交换图片位置
- **自动刷新**: 参数改变后自动更新预览

### 7. 多格式导出
- **位图格式**: PNG、JPG、TIFF
- **矢量格式**: PDF、SVG、EPS
- **DPI设置**: 72-1200 DPI可调(位图)
- **批量导出**: 可同时导出多种格式
- **MD5校验**: 自动生成MD5校验文件
- **导出日志**: JSON格式记录所有参数

## 📦 安装

### 系统要求
- Python 3.7+
- Windows / macOS / Linux

### 安装依赖
```bash
pip install -r requirements.txt
```

### 依赖包
- **PyQt5**: GUI框架
- **Pillow**: 图像处理
- **reportlab**: PDF生成
- **PyPDF2**: PDF处理
- **numpy**: 数值计算

## 🚀 使用方法

### 启动程序
```bash
python main.py
```

### 基本流程
1. **加载图片**
   - 点击"选择文件夹"或"选择文件"
   - 程序自动检测宽高比
   - 如有不匹配，选择自动裁切或取消

2. **设置布局**
   - 选择预设方案或自定义行列数
   - 查看布局信息(如"末行空出N格")
   - 选择空格策略(居左/居中/分散)

3. **调整单元格**
   - 设置单元格宽度和高度
   - 勾选"锁定宽高比"保持比例
   - 点击"还原原始尺寸"复原

4. **配置编号**
   - 勾选"显示编号"
   - 选择编号格式(1 2 3 / ① ② ③ / a b c等)
   - 设置编号位置(九宫格)
   - 调整字号和颜色

5. **添加Scale Bar (可选)**
   - 勾选"显示 Scale Bar"
   - 选择物镜倍率(10X已配置)
   - 设置比例尺长度(默认10 μm)
   - 选择显示位置(左下/居中/右下)
   - 查看自动计算的像素长度

6. **预览确认**
   - 点击"更新预览"(或启用自动刷新)
   - 使用鼠标滚轮+Ctrl缩放
   - 拖拽图片交换位置

7. **导出结果**
   - 选择输出格式(PNG/JPG/TIFF/PDF/SVG/EPS)
   - 设置DPI(位图格式)
   - 选择输出目录
   - 点击"导出拼图"

## 🎯 高级功能

### 拖拽重排序
- 按住鼠标左键拖动单元格
- 拖到目标位置释放
- 立即交换两个图片的位置

### 网格显示
- 菜单栏 → 视图 → 显示网格
- 淡色虚线辅助对齐
- 不影响最终导出结果

### 自动刷新
- 工具栏勾选"自动刷新"
- 参数改变后200ms自动更新
- 大量图片时可关闭以提高性能

### 内存优化
- 自动检测大图片(>50MB)
- 预估总内存使用
- 超过阈值时弹出警告

### Scale Bar 配置
- **10X物镜**: 已配置 1.0304 μm/px (基于原始图片尺寸)
- **4X/20X物镜**: 预留接口，可后续配置
- **显示逻辑**: 仅在选择已配置物镜时启用
- **绘制位置**: 在合成图的空白区域或最下方
- **缩放计算**: 自动根据 (单元格尺寸/原始尺寸) 缩放比例尺
- **示例**: 原图2688px缩放到200px，10μm比例尺从9.7px缩放到0.72px
- **建议**: 小单元格(<300px)使用较长比例尺(50-100μm)以保证可见

## 📁 项目结构

```
multi_image_layout/
├── main.py                   # 入口文件
├── main_window.py           # 主窗口实现
├── ui_panels.py             # 参数面板UI
├── worker_threads.py        # 后台线程
├── image_manager.py         # 图片管理
├── layout_engine.py         # 布局引擎
├── numbering.py             # 编号系统
├── scale_bar.py             # Scale Bar比例尺系统
├── export_manager.py        # 导出管理
├── preview_canvas.py        # 预览画布
├── layout_compositor.py     # 布局合成
├── requirements.txt         # 依赖清单
├── README.md               # 本文档
└── .image_layout_cache.json # 缓存文件(自动生成)
```

## 🔧 技术细节

### 图片缓存机制
- 首次加载时扫描所有图片元数据
- 保存为隐藏的JSON缓存文件
- 记录路径、尺寸、宽高比、修改时间
- 二次加载时对比修改时间，仅更新变动文件

### 宽高比验证
- 以第一张图为基准
- 允许1%的误差容忍
- 检测到不匹配时提供两种选择:
  - A: 自动裁切(中心区域)
  - B: 取消加载

### 布局算法
- 自动计算最后一行图片数和空格数
- 三种空格策略:
  - **居左**: 图片从左侧开始排列
  - **居中**: 空格平均分配两侧
  - **分散**: 图片均匀分布整行

### 编号渲染
- 带圈数字支持1-50(Unicode)
- 字母支持无限延伸(a, b, ..., z, aa, ab...)
- 罗马数字支持1-3999
- 自动检测字号是否溢出单元格

### 导出优化
- 多格式并行导出
- 进度条实时反馈
- 大尺寸图片自动预警
- MD5校验确保文件完整性

## 💡 使用技巧

### 1. 快速调整布局
- 拖动分隔栏调整面板宽度
- 使用预设方案快速切换
- 质数图片数时参考建议布局

### 2. 编号最佳实践
- 小单元格(<100px)使用较小字号(12-16px)
- 深色图片使用白色编号+黑色背景
- 浅色图片使用黑色编号+白色背景
- 九宫格位置根据图片内容选择

### 3. Scale Bar 使用建议
- **显微镜图片**: 勾选Scale Bar显示真实尺度
- **物镜倍率**: 确保选择正确的物镜(当前仅10X可用)
- **长度选择**: 一般选择10-100 μm便于识别
- **位置**: "居中"最常用，"左下/右下"避免遮挡重要内容
- **检查**: 导出前在预览中确认比例尺清晰可见

### 4. 导出建议
- **学术论文**: TIFF (300 DPI) 或 PDF
- **网页使用**: PNG (72-150 DPI)
- **打印输出**: TIFF/PDF (300-600 DPI)
- **矢量编辑**: SVG 或 EPS

### 5. 性能优化
- 大量图片(>100张)时:
  - 减小单元格尺寸
  - 关闭自动刷新
  - 手动点击更新预览
- 超大原图(>4000px)时:
  - 使用适中的单元格尺寸(200-500px)
  - 避免过高DPI设置

## ⚠️ 注意事项

1. **图片格式**: 支持JPG, PNG, TIFF, BMP, WebP
2. **宽高比**: 所有图片必须相同宽高比(±1%容差)
3. **文件名**: 支持中文路径和文件名
4. **内存**: 大量高分辨率图片可能占用较多内存
5. **矢量格式**: SVG/EPS实际嵌入位图，非真正矢量
6. **超大布局**: >1000单元格时矢量格式可能较慢
7. **Scale Bar**: 
   - 仅10X物镜已配置(1.0304 μm/px)
   - 4X和20X物镜需要后续配置标定值
   - 选择未配置物镜时Scale Bar不显示
   - 比例尺绘制在合成图最下方

## 🐛 故障排除

### 问题: 无法加载图片
**解决**: 
- 检查图片格式是否支持
- 确认文件未被占用
- 检查文件权限

### 问题: 宽高比不匹配错误
**解决**:
- 选择"自动裁切"统一比例
- 或手动编辑图片统一尺寸

### 问题: 导出失败
**解决**:
- 检查输出目录是否有写权限
- 确认磁盘空间充足
- 尝试减小DPI或单元格尺寸

### 问题: 预览卡顿
**解决**:
- 关闭自动刷新
- 减小单元格尺寸
- 减少图片数量

### 问题: 编号显示异常
**解决**:
- 增大字号
- 调整编号位置
- 确认系统已安装所需字体

## 📝 更新日志

### v1.0.0 (2025-01-10)
- 初始版本发布
- 支持多图片加载和布局
- 实现6种编号格式
- 支持6种导出格式
- 实时预览和拖拽排序

## 📄 许可证

CellToolbox Project - Internal Tool

## 🤝 贡献

欢迎提交问题和改进建议！

## 📧 联系方式

CellToolbox Project Team
