# Scale Bar 功能使用指南

## ✨ 功能概述

Scale Bar (比例尺) 功能允许在多图拼接结果上添加标定的比例尺，用于显示图片的真实尺度。

## 📋 配置说明

### 已配置物镜

| 物镜倍率 | 标定值 (μm/px) | 状态 |
|---------|---------------|------|
| **10X** | **1.0304** | ✅ 已配置 |
| 4X      | -             | ⏳ 待配置 |
| 20X     | -             | ⏳ 待配置 |

### 10X 物镜示例计算

- **比例**: 1.0304 μm/px (基于**原始图片**尺寸)
- **10 μm 比例尺**: 10 ÷ 1.0304 ≈ **9.7 像素 (原图)**
- **20 μm 比例尺**: 20 ÷ 1.0304 ≈ **19.4 像素 (原图)**
- **50 μm 比例尺**: 50 ÷ 1.0304 ≈ **48.5 像素 (原图)**

**缩放示例**:
- 原始图片: 2000×2000 px
- 拼图单元格: 200×200 px
- 缩放比例: 0.1 (200/2000)
- 10 μm 在拼图中 = 9.7 × 0.1 ≈ **1 像素**
- 100 μm 在拼图中 = 97.0 × 0.1 ≈ **10 像素**

## 🎯 使用步骤

### 1. 启用 Scale Bar

在参数面板中找到 "Scale Bar (比例尺)" 分组：

```
□ 显示 Scale Bar  ← 勾选此项
```

### 2. 选择物镜倍率

```
物镜: [10X ▼]  ← 选择 10X
```

选择后会自动显示标定信息：
```
10X: 10 μm = 9.7 px (原图)
比例: 1.0304 μm/px
```

**注意**: 显示的像素数是基于**原始图片尺寸**计算的，拼图时会自动按缩放比例调整。

### 3. 设置比例尺长度

```
长度: [10] μm  ← 可调整 1-1000 μm
```

常用长度：
- **10 μm**: 适合细胞尺度
- **20 μm**: 适合小视野
- **50 μm**: 适合中等视野
- **100 μm**: 适合大视野

### 4. 选择显示位置

```
位置: [居中 ▼]
```

可选位置：
- **左下**: 左下角显示
- **居中**: 底部居中显示 (默认)
- **右下**: 右下角显示

### 5. 更新预览

点击 "更新预览" 按钮，Scale Bar 会绘制在合成图的底部。

## 🎨 显示效果

Scale Bar 由以下元素组成：

```
┌─────────────────────┐
│  黑色半透明背景       │
│  ┌─────────┐  白色   │
│  │10 μm    │  文字   │
│  └─────────┘        │
│   白色比例尺条        │
└─────────────────────┘
```

- **比例尺条**: 白色矩形，高度5像素
- **文字**: 白色 "XX μm" 标注
- **背景**: 黑色半透明，增强可见性
- **位置**: 底部边缘，留20像素边距

## ⚠️ 注意事项

### 1. 物镜选择

- ✅ **已配置**: 选择10X时，Scale Bar正常显示
- ❌ **未配置**: 选择4X/20X或"无"时，Scale Bar不显示
- 📝 **提示**: 信息栏会显示"未配置比例"

### 2. 图片来源

Scale Bar功能假设所有图片来自**相同物镜**拍摄：

- ✅ **正确**: 所有图片都是10X物镜拍摄 → 选择10X
- ❌ **错误**: 混合不同物镜的图片 → 比例尺不准确

### 3. 标定值更新

如需更新或添加其他物镜的标定值，修改 `scale_bar.py`:

```python
class ScaleBarStyle:
    def __init__(self):
        # ...
        self.calibrations = {
            Objective.OBJ_4X: None,      # ← 在此添加4X标定值
            Objective.OBJ_10X: 1.0304,   # ← 已配置
            Objective.OBJ_20X: None,     # ← 在此添加20X标定值
            Objective.NONE: None
        }
```

### 4. 导出格式

Scale Bar会包含在所有导出格式中：
- ✅ PNG / JPG / TIFF: Scale Bar嵌入位图
- ✅ PDF / SVG / EPS: Scale Bar随图片导出

## 🔍 缩放计算原理

### 为什么需要缩放计算？

Scale Bar的标定值 (1.0304 μm/px) 是基于**原始图片**的像素尺寸。当拼图时，图片会被缩放到单元格尺寸，Scale Bar也需要相应缩放。

### 计算公式

```
缩放比例 = 单元格宽度 / 原始图片宽度

Scale Bar像素长度 = (比例尺长度 μm / 标定值 μm/px) × 缩放比例
```

### 实例

假设：
- **原始图片**: 2688 × 1520 px
- **单元格**: 200 × 113 px
- **缩放比例**: 200 / 2688 ≈ 0.0744
- **比例尺长度**: 10 μm
- **标定值**: 1.0304 μm/px

计算：
1. 原图中10 μm = 10 / 1.0304 ≈ **9.7 px**
2. 拼图中10 μm = 9.7 × 0.0744 ≈ **0.72 px**

因此，如果单元格只有200px，10 μm的比例尺会非常小 (<1像素)，建议使用更长的比例尺（如100 μm）。

### 建议

根据单元格尺寸选择合适的比例尺长度：

| 单元格尺寸 | 建议比例尺长度 | 拼图中像素长度 (10X) |
|-----------|--------------|-------------------|
| 100 px    | 100-200 μm   | 7-15 px          |
| 200 px    | 50-100 μm    | 7-15 px          |
| 500 px    | 20-50 μm     | 9-23 px          |
| 1000 px   | 10-20 μm     | 9-19 px          |

## 🔧 高级配置

如需自定义Scale Bar样式，可在 `scale_bar.py` 中修改：

```python
class ScaleBarStyle:
    def __init__(self):
        self.bar_height = 5              # 比例尺高度(像素)
        self.bar_color = (255, 255, 255) # 比例尺颜色(RGB)
        self.bg_color = (0, 0, 0)        # 背景颜色(RGB)
        self.font_size = 16              # 字体大小
        self.text_color = (255, 255, 255) # 文字颜色(RGB)
        self.with_background = True       # 是否显示背景
```

## 💡 使用建议

### 科学论文

```
✅ 勾选 Scale Bar
✅ 选择 10X (如适用)
✅ 长度设为 10-50 μm
✅ 位置选择"居中"
✅ 导出为 TIFF (300 DPI) 或 PDF
```

### 学术报告

```
✅ 勾选 Scale Bar
✅ 选择 10X
✅ 长度设为 20-100 μm (更明显)
✅ 位置选择"左下"或"右下"
✅ 导出为 PNG (150 DPI)
```

### 数据分析

```
□ 不勾选 Scale Bar (可选)
✅ 仅在需要标定时启用
✅ 确保所有图片同一物镜
```

## 📝 更新日志

### v1.1 (2025-01-11)
- 🔧 **修复**: Scale Bar像素计算现在基于**原始图片尺寸**而非拼图尺寸
- ✅ 自动缩放计算: scale_factor = 单元格尺寸 / 原始尺寸
- ✅ UI信息更新: 显示"XX px (原图)"以明确计算基准
- ✅ 文档完善: 添加缩放计算原理和使用建议

### v1.0 (2025-01-11)
- ✅ 实现基础Scale Bar功能
- ✅ 配置10X物镜标定 (1.0304 μm/px)
- ✅ 支持3种显示位置
- ✅ 自动像素长度计算
- ✅ 集成到UI参数面板
- ✅ 支持所有导出格式

### 待完成
- ⏳ 4X物镜标定值配置
- ⏳ 20X物镜标定值配置
- ⏳ 自定义标定值输入界面

## 📧 技术支持

如有问题或需要添加其他物镜配置，请联系开发团队。

---

**CellToolbox Project - Multi-Image Layout Tool**  
*Version 1.0 - Scale Bar Feature*
