# 比例控制使用指南

## ✨ 功能概述

从 v1.4 开始，**多图拼接工具**的单元格尺寸控制从**像素模式**升级为**比例模式**，提供更直观的缩放体验。

## 🔄 重大变更

### 原先模式 (v1.3 及之前)

```
单元格尺寸:
宽度: [200] px
高度: [200] px
```

**问题**:
- ❌ 需要手动计算合适的像素值
- ❌ 不同尺寸图片需要不同的像素设置
- ❌ 不直观，难以快速调整

### 新模式 (v1.4)

```
单元格尺寸 (比例):
缩放比例: [1.0] x
实际像素: 2688 × 1520 px
```

**优势**:
- ✅ 基于原始图片尺寸的倍数控制
- ✅ 通用性强，适用任何尺寸图片
- ✅ 直观易懂：0.5x = 缩小一半，2.0x = 放大一倍
- ✅ 像素值自动计算并显示

## 🎯 使用方法

### 1. 基础操作

**加载图片后**:
```
单元格尺寸 (比例):
缩放比例: [1.0] x          ← 可调整
实际像素: 2688 × 1520 px   ← 自动显示
```

**调整缩放比例**:
- 点击输入框直接输入数值
- 使用上下箭头微调
- 范围: 0.01x ~ 10.0x
- 步进: 0.1x

### 2. 常用缩放比例

| 比例 | 说明 | 适用场景 |
|------|------|---------|
| **0.1x** | 缩小到1/10 | 大量图片预览 |
| **0.25x** | 缩小到1/4 | 快速浏览 |
| **0.5x** | 缩小一半 | 节省空间 |
| **1.0x** | 原始尺寸 | 标准输出 |
| **1.5x** | 放大50% | 细节展示 |
| **2.0x** | 放大一倍 | 放大显示 |

### 3. 实时像素显示

**原始图片**: 2688 × 1520 px

```
比例 0.1x  → 实际像素: 268 × 152 px
比例 0.5x  → 实际像素: 1344 × 760 px
比例 1.0x  → 实际像素: 2688 × 1520 px
比例 2.0x  → 实际像素: 5376 × 3040 px
```

### 4. 还原原始尺寸

点击 **"还原原始尺寸 (1.0x)"** 按钮
→ 缩放比例自动重置为 1.0x

## 📐 技术原理

### 计算公式

```python
实际宽度(px) = 原始宽度(px) × 缩放比例
实际高度(px) = 原始高度(px) × 缩放比例
```

### 示例计算

**原始图片**: 2688 × 1520 px  
**缩放比例**: 0.5x

```
实际宽度 = 2688 × 0.5 = 1344 px
实际高度 = 1520 × 0.5 = 760 px
```

### 自动宽高比锁定

勾选 **"锁定宽高比"** 时：
- 缩放比例同时应用于宽和高
- 保持原始宽高比
- 避免图片变形

## 🎨 UI 布局

### 参数面板

```
┌───────────────────────────┐
│ 单元格尺寸 (比例)         │
├───────────────────────────┤
│ 缩放比例: [1.00] x        │
│ 实际像素: 2688 × 1520 px  │
│ □ 锁定宽高比              │
│ [还原原始尺寸 (1.0x)]     │
└───────────────────────────┘
```

### 信息显示

- **缩放比例**: 用户可编辑，主控制
- **实际像素**: 只读显示，灰色字体
- **锁定宽高比**: 默认勾选
- **还原按钮**: 快速重置

## 💡 使用技巧

### 1. 快速预览大量图片

```
场景: 100张 2688×1520 的图片
目标: 快速预览全部布局

操作:
1. 加载图片
2. 设置缩放比例: 0.1x
3. 实际像素: 268 × 152 px
4. 更新预览

优势: 内存占用小，预览快速
```

### 2. 高质量导出

```
场景: 准备用于论文的拼图
目标: 保持原始清晰度

操作:
1. 加载图片
2. 缩放比例: 1.0x (默认)
3. 导出 TIFF (300 DPI)

优势: 无损质量，适合打印
```

### 3. 适配特定尺寸

```
场景: PPT 需要特定像素尺寸
目标: 每个单元格 500×282 px

计算:
原始: 2688 × 1520 px
目标: 500 px 宽度
比例: 500 / 2688 ≈ 0.19x

操作:
1. 设置缩放比例: 0.19x
2. 检查实际像素: 511 × 289 px
3. 微调至: 0.186x
4. 实际像素: 500 × 283 px ✓
```

### 4. 批量处理不同尺寸图片

```
场景: 处理多组不同尺寸的图片

优势:
- 同一比例设置适用所有图片
- 无需针对不同尺寸调整像素值
- 工作流程标准化

示例:
- 第一组: 2688×1520 @ 0.5x → 1344×760
- 第二组: 1920×1080 @ 0.5x → 960×540  
- 第三组: 3840×2160 @ 0.5x → 1920×1080
→ 比例统一，像素自适应
```

## 🔍 与 Scale Bar 的配合

### 重要说明

Scale Bar 的标定值 (μm/px) 是基于**原始图片尺寸**：

```
原始图片: 2688 × 1520 px
10X物镜: 1.0304 μm/px

10 μm 比例尺:
- 原图中: 10 / 1.0304 ≈ 9.7 px
- 0.5x 拼图: 9.7 × 0.5 ≈ 4.9 px
- 0.1x 拼图: 9.7 × 0.1 ≈ 1.0 px
```

### 建议

| 缩放比例 | 建议Scale Bar长度 | 拼图中像素 |
|---------|------------------|-----------|
| 0.1x    | 100 μm           | ~10 px    |
| 0.25x   | 50 μm            | ~12 px    |
| 0.5x    | 20 μm            | ~10 px    |
| 1.0x    | 10 μm            | ~10 px    |

**原则**: 保持 Scale Bar 在拼图中的像素长度 ≥ 10 px 以确保可见

## ⚙️ 技术实现

### 核心组件

**ui_panels.py**:

```python
class ParameterPanel:
    def __init__(self):
        # Scale control
        self.spin_cell_scale = QDoubleSpinBox()
        self.spin_cell_scale.setRange(0.01, 10.0)
        self.spin_cell_scale.setValue(1.0)
        
        # Pixel display (read-only)
        self.lbl_cell_pixels = QLabel("实际像素: --")
        
        # Original size storage
        self.original_width = 200
        self.original_height = 200
    
    def set_original_size(self, width: int, height: int):
        """Called when images are loaded"""
        self.original_width = width
        self.original_height = height
        self.update_pixel_display()
    
    def update_pixel_display(self):
        """Update pixel display based on scale"""
        scale = self.spin_cell_scale.value()
        width_px = int(self.original_width * scale)
        height_px = int(self.original_height * scale)
        self.lbl_cell_pixels.setText(f"实际像素: {width_px} × {height_px} px")
    
    def get_parameters(self) -> dict:
        """Calculate actual pixel size"""
        scale = self.spin_cell_scale.value()
        cell_width = int(self.original_width * scale)
        cell_height = int(self.original_height * scale)
        
        return {
            'cell_width': cell_width,
            'cell_height': cell_height,
            'cell_scale': scale,
            # ... other parameters
        }
```

### 工作流程

```
1. 加载图片
   ↓
2. 获取第一张图片尺寸
   ↓
3. set_original_size(width, height)
   ↓
4. 初始化比例为 1.0x
   ↓
5. 显示实际像素
   ↓
6. 用户调整比例
   ↓
7. 实时更新像素显示
   ↓
8. get_parameters() 计算实际像素
   ↓
9. 传递给合成器
```

### 数据流

```
用户输入比例
    ↓
on_cell_scale_changed()
    ↓
update_pixel_display()
    ↓
lbl_cell_pixels更新
    ↓
parameters_changed信号
    ↓
get_parameters()
    ↓
计算实际像素
    ↓
传递给compositor
```

## 📊 性能影响

### 内存占用对比

**25张图片 (2688×1520 px 每张)**

| 比例 | 单元格尺寸 | 合成图尺寸 | 内存占用 |
|------|-----------|-----------|---------|
| 0.1x | 268×152   | 1340×760  | ~3 MB   |
| 0.5x | 1344×760  | 6720×3800 | ~77 MB  |
| 1.0x | 2688×1520 | 13440×7600| ~310 MB |
| 2.0x | 5376×3040 | 26880×15200| ~1.2 GB|

**建议**:
- 预览: 使用 0.1x ~ 0.5x
- 导出: 使用 1.0x (保持原始质量)
- 大尺寸: 谨慎使用 > 1.0x

### 处理速度

| 比例 | 相对处理时间 |
|------|------------|
| 0.1x | 1x (最快) |
| 0.5x | 5x        |
| 1.0x | 20x       |
| 2.0x | 80x       |

## 🐛 常见问题

### Q1: 为什么像素显示为"--"?

**A**: 尚未加载图片。加载图片后会自动显示实际像素。

### Q2: 比例很小但文件很大?

**A**: 比例控制的是单元格尺寸，合成图尺寸 = 单元格尺寸 × 网格大小。

示例:
```
比例: 0.5x
单元格: 1344×760 px
网格: 10×10
合成图: 13440×7600 px (仍然很大!)
```

### Q3: 如何快速找到合适的比例?

**A**: 建议流程:
1. 先设置 0.1x 预览布局
2. 确认布局后调整到 0.5x 检查细节
3. 满意后设置 1.0x 导出

### Q4: 比例能超过1.0x吗?

**A**: 可以，范围是 0.01x ~ 10.0x。但超过 1.0x 会:
- 放大图片(可能模糊)
- 显著增加内存占用
- 延长处理时间

### Q5: 锁定宽高比有什么用?

**A**: 默认勾选，确保:
- 缩放比例同时应用于宽和高
- 保持原始宽高比
- 避免图片变形

**取消勾选**: 目前仍然保持锁定(未来版本可能支持独立缩放)

## 📝 更新日志

### v1.4 (2025-01-12)
- 🎉 **重大更新**: 单元格尺寸改为比例控制
- ✅ 新增缩放比例输入 (0.01x ~ 10.0x)
- ✅ 新增实际像素只读显示
- ✅ 新增"还原原始尺寸"按钮
- ✅ 自动根据第一张图片设置原始尺寸
- ✅ 实时计算和显示实际像素
- ✅ 参数传递自动转换为像素值
- ⚠️ **不兼容**: 旧版本的像素设置不再适用

### v1.3 (2025-01-12)
- 拖放功能
- UI 优化

### v1.2 (2025-01-12)
- 滚动面板
- 紧凑布局

### v1.1 (2025-01-11)
- Scale Bar 功能

## 🚀 快速开始

```bash
cd e:\Documents\Codes\Matlab\CellToolbox\python-version\ImageProcessor\multi_image_layout
python main.py
```

### 测试流程

1. **拖拽文件夹加载图片**
2. **查看原始尺寸**: 例如 2688×1520
3. **调整缩放比例**: 试试 0.5x
4. **查看实际像素**: 1344×760 px
5. **点击"还原原始尺寸"**: 重置为 1.0x
6. **更新预览**: 查看效果

---

**CellToolbox Project - Multi-Image Layout Tool**  
*Scale Control Feature v1.4*
