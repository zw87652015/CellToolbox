# Python灰度TIFF图像像素放大工具开发指南

## 程序主体要求

### 核心功能
1. **TIFF图像读取**：读取8位或16位灰度TIFF图像，保留原始像素数据
2. **像素级放大**：使用最近邻插值算法，将每个原始像素按指定比例放大为N×N像素块
3. **分辨率控制**：输出图像分辨率=原始分辨率×放大倍数，保持原始宽高比
4. **实时预览**：提供UI界面显示放大效果，支持鼠标滚轮缩放查看细节
5. **导出功能**：将处理后的图像保存为png或tiff格式，保留硬边缘像素效果

### 技术规范
- 使用`Pillow`库处理图像读写，确保TIFF格式兼容性
- 使用`OpenCV`或`scipy.ndimage`实现最近邻插值放大
- 使用PyQt5构建GUI，支持图像显示和交互
- 放大算法必须采用最近邻插值，禁止任何平滑或抗锯齿处理
- 内存处理：支持处理至少5000×5000像素输入图像，放大倍数不超过50倍

## 实现思路

### 图像处理模块
```python
def load_tiff(path):
    """读取TIFF文件，返回numpy数组和原始尺寸"""
    with Image.open(path) as img:
        if img.mode != 'L':
            raise ValueError("仅支持灰度图像")
        return np.array(img), img.size

def pixel_expand(image_array, scale_factor):
    """使用最近邻插值放大图像"""
    h, w = image_array.shape
    new_h, new_w = h * scale_factor, w * scale_factor
    # 使用numpy重复实现像素块放大
    expanded = np.repeat(np.repeat(image_array, scale_factor, axis=0), scale_factor, axis=1)
    return expanded.astype(image_array.dtype)
```

### GUI界面设计
1. **主窗口**：包含图像显示区域、控制面板、状态栏
2. **显示区域**：使用`Canvas`或`QLabel`显示图像，支持鼠标滚轮缩放
3. **控制面板**：
   - 放大倍数输入框（整数，1-50）
   - 输出分辨率显示（实时计算）
   - 导出按钮（保存PNG）
4. **交互逻辑**：
   - 加载图像后自动显示原始尺寸
   - 调整放大倍数时实时更新预览
   - 鼠标悬停显示当前像素坐标和灰度值

### 性能优化
1. **预览模式**：显示时降采样，保持视觉效果同时减少内存占用
2. **延迟处理**：放大倍数调整完成后延迟200ms再处理图像
3. **分块处理**：对超大图像采用分块处理，避免内存溢出

### 错误处理
1. **格式验证**：非灰度TIFF文件拒绝加载并提示
2. **内存保护**：放大后图像尺寸超过1GB时警告并限制放大倍数
3. **文件保护**：导出时若文件已存在，提示覆盖或重命名

### 代码结构
```
pixel_expand_tool/
├── core/
│   ├── image_processor.py    # 图像处理核心
│   └── utils.py              # 工具函数
├── gui/
│   ├── main_window.py        # 主窗口
│   ├── image_viewer.py       # 图像显示组件
│   └── controls.py           # 控制面板
├── resources/
│   └── icons/                # UI图标
└── main.py                   # 程序入口
```

### 关键实现细节
1. **最近邻插值**：必须使用`order=0`的插值方法，确保无平滑效果
2. **像素块对齐**：放大后的每个像素块边界必须与显示网格对齐
3. **灰度保留**：16位TIFF需保留原始位深，导出时可选8位或16位PNG
4. **坐标映射**：预览缩放时，鼠标位置到原始图像像素的坐标转换需精确

### 界面响应要求
- 放大倍数调整响应时间<100ms（预览模式）
- 图像加载时间<2s（5000×5000图像）
- 导出处理时间<5s（10倍放大，500MP输出）

### 输出规范
- 导出PNG包含完整的像素块信息，无压缩损失
- 文件名格式：`原文件名_放大倍数x_分辨率.png`
- 元数据保留：包含原始TIFF的解析度信息（如有）